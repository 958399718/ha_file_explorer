<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="https://cdn.bootcss.com/material-design-icons/3.0.1/iconfont/material-icons.min.css" rel="stylesheet">
	<link href="https://cdn.bootcss.com/materialize/0.97.8/css/materialize.min.css" rel="stylesheet">
	<style>
	@media screen and (max-width: 375px) {
		.input-mode {
			width:110px;
		}
	}
	</style>
</head>

<body>

    <div id="app">
        <nav class="teal">
            <div class="nav-wrapper">
                <a href="#" class="brand-logo right">版本:{{ver}}&emsp;</a>
                <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
                <ul class="left hide-on-med-and-down">
                    <li> <a @click="opendir('')">HA根目录</a></li>
                    <li v-for="item in dir">
                        <a @click="opendir(item)">{{item}}</a>
                    </li>
                </ul>
                <!-- 手机 -->
                <ul class="side-nav" id="nav-mobile">
                    <li> <a @click="opendir('')">HA根目录</a></li>
                    <li v-for="item in dir">
                        <a @click="opendir(item)">{{item}}</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container" v-show="!content.path">
            <ul class="collection">
                <li class="collection-item avatar" v-for="(item,index) in list" >
                    <i
                        :class="`material-icons circle ${item.type == 'dir' ? '' : 'green'}`">{{item.type == 'dir' ? 'folder' : 'insert_drive_file'}}</i>
                    <span class="title">{{item.name}}</span>
                    <p style="margin-top:5px;"> 
					<span class="chip" >
					{{item.edit}}
					</span>
					  <span class="chip" v-show="item.type != 'dir' && item.size != 0">{{item.size | format}}</span>
					  
					  </p>
					  <!--菜单-->
                    <a href="#!" class='dropdown-button secondary-content' :data-activates='`dropdown${index}`'>						
						 <i class="material-icons">more_vert</i>
					</a>
					<ul :id='`dropdown${index}`' class='dropdown-content'>					 
						<li @click="show(item)" v-if="item.type == 'dir'"><a href="#!">打开</a></li>					 
						<li @click="show(item)" v-else><a href="#!">编辑</a></li>
						<li class="divider"></li>
						<li @click="deleteClick(item)"><a href="#!">删除</a></li>
					</ul>
                </li>
            </ul>
        </div>

        <div v-show="content.path" style="padding:10px;">
			  <div class="input-field input-mode" style="display:inline-block;">
					<select onchange="editor.setOption('mode', this.value)" id="mode">
                      <option value="ace/mode/abap">abap</option>
                      <option value="ace/mode/abc">abc</option>
                      <option value="ace/mode/actionscript">actionscript</option>
                      <option value="ace/mode/ada">ada</option>
                      <option value="ace/mode/apache_conf">apache_conf</option>
                      <option value="ace/mode/asciidoc">asciidoc</option>
                      <option value="ace/mode/assembly_x86">assembly_x86</option>
                      <option value="ace/mode/autohotkey">autohotkey</option>
                      <option value="ace/mode/batchfile">batchfile</option>
                      <option value="ace/mode/bro">bro</option>
                      <option value="ace/mode/c_cpp">c_cpp</option>
                      <option value="ace/mode/c9search">c9search</option>
                      <option value="ace/mode/cirru">cirru</option>
                      <option value="ace/mode/clojure">clojure</option>
                      <option value="ace/mode/cobol">cobol</option>
                      <option value="ace/mode/coffee">coffee</option>
                      <option value="ace/mode/coldfusion">coldfusion</option>
                      <option value="ace/mode/csharp">csharp</option>
                      <option value="ace/mode/css">css</option>
                      <option value="ace/mode/curly">curly</option>
                      <option value="ace/mode/d">d</option>
                      <option value="ace/mode/dart">dart</option>
                      <option value="ace/mode/diff">diff</option>
                      <option value="ace/mode/django">django</option>
                      <option value="ace/mode/dockerfile">dockerfile</option>
                      <option value="ace/mode/dot">dot</option>
                      <option value="ace/mode/drools">drools</option>
                      <option value="ace/mode/dummy">dummy</option>
                      <option value="ace/mode/dummysyntax">dummysyntax</option>
                      <option value="ace/mode/eiffel">eiffel</option>
                      <option value="ace/mode/ejs">ejs</option>
                      <option value="ace/mode/elixir">elixir</option>
                      <option value="ace/mode/elm">elm</option>
                      <option value="ace/mode/erlang">erlang</option>
                      <option value="ace/mode/forth">forth</option>
                      <option value="ace/mode/fortran">fortran</option>
                      <option value="ace/mode/ftl">ftl</option>
                      <option value="ace/mode/gcode">gcode</option>
                      <option value="ace/mode/gherkin">gherkin</option>
                      <option value="ace/mode/gitignore">gitignore</option>
                      <option value="ace/mode/glsl">glsl</option>
                      <option value="ace/mode/gobstones">gobstones</option>
                      <option value="ace/mode/golang">golang</option>
                      <option value="ace/mode/groovy">groovy</option>
                      <option value="ace/mode/haml">haml</option>
                      <option value="ace/mode/handlebars">handlebars</option>
                      <option value="ace/mode/haskell">haskell</option>
                      <option value="ace/mode/haskell_cabal">haskell_cabal</option>
                      <option value="ace/mode/haxe">haxe</option>
                      <option value="ace/mode/hjson">hjson</option>
                      <option value="ace/mode/html">html</option>
                      <option value="ace/mode/html_elixir">html_elixir</option>
                      <option value="ace/mode/html_ruby">html_ruby</option>
                      <option value="ace/mode/ini">ini</option>
                      <option value="ace/mode/io">io</option>
                      <option value="ace/mode/jack">jack</option>
                      <option value="ace/mode/jade">jade</option>
                      <option value="ace/mode/java">java</option>
                      <option value="ace/mode/javascript">javascript</option>
                      <option value="ace/mode/json">json</option>
                      <option value="ace/mode/jsoniq">jsoniq</option>
                      <option value="ace/mode/jsp">jsp</option>
                      <option value="ace/mode/jsx">jsx</option>
                      <option value="ace/mode/julia">julia</option>
                      <option value="ace/mode/kotlin">kotlin</option>
                      <option value="ace/mode/latex">latex</option>
                      <option value="ace/mode/less">less</option>
                      <option value="ace/mode/liquid">liquid</option>
                      <option value="ace/mode/lisp">lisp</option>
                      <option value="ace/mode/livescript">livescript</option>
                      <option value="ace/mode/logiql">logiql</option>
                      <option value="ace/mode/lsl">lsl</option>
                      <option value="ace/mode/lua">lua</option>
                      <option value="ace/mode/luapage">luapage</option>
                      <option value="ace/mode/lucene">lucene</option>
                      <option value="ace/mode/makefile">makefile</option>
                      <option value="ace/mode/markdown">markdown</option>
                      <option value="ace/mode/mask">mask</option>
                      <option value="ace/mode/matlab">matlab</option>
                      <option value="ace/mode/maze">maze</option>
                      <option value="ace/mode/mel">mel</option>
                      <option value="ace/mode/mushcode">mushcode</option>
                      <option value="ace/mode/mysql">mysql</option>
                      <option value="ace/mode/nix">nix</option>
                      <option value="ace/mode/nsis">nsis</option>
                      <option value="ace/mode/objectivec">objectivec</option>
                      <option value="ace/mode/ocaml">ocaml</option>
                      <option value="ace/mode/pascal">pascal</option>
                      <option value="ace/mode/perl">perl</option>
                      <option value="ace/mode/pgsql">pgsql</option>
                      <option value="ace/mode/php">php</option>
                      <option value="ace/mode/powershell">powershell</option>
                      <option value="ace/mode/praat">praat</option>
                      <option value="ace/mode/prolog">prolog</option>
                      <option value="ace/mode/properties">properties</option>
                      <option value="ace/mode/protobuf">protobuf</option>
                      <option value="ace/mode/python">python</option>
                      <option value="ace/mode/r">r</option>
                      <option value="ace/mode/razor">razor</option>
                      <option value="ace/mode/rdoc">rdoc</option>
                      <option value="ace/mode/rhtml">rhtml</option>
                      <option value="ace/mode/rst">rst</option>
                      <option value="ace/mode/ruby">ruby</option>
                      <option value="ace/mode/rust">rust</option>
                      <option value="ace/mode/sass">sass</option>
                      <option value="ace/mode/scad">scad</option>
                      <option value="ace/mode/scala">scala</option>
                      <option value="ace/mode/scheme">scheme</option>
                      <option value="ace/mode/scss">scss</option>
                      <option value="ace/mode/sh">sh</option>
                      <option value="ace/mode/sjs">sjs</option>
                      <option value="ace/mode/smarty">smarty</option>
                      <option value="ace/mode/snippets">snippets</option>
                      <option value="ace/mode/soy_template">soy_template</option>
                      <option value="ace/mode/space">space</option>
                      <option value="ace/mode/sql">sql</option>
                      <option value="ace/mode/sqlserver">sqlserver</option>
                      <option value="ace/mode/stylus">stylus</option>
                      <option value="ace/mode/svg">svg</option>
                      <option value="ace/mode/swift">swift</option>
                      <option value="ace/mode/tcl">tcl</option>
                      <option value="ace/mode/tex">tex</option>
                      <option value="ace/mode/text">text</option>
                      <option value="ace/mode/textile">textile</option>
                      <option value="ace/mode/toml">toml</option>
                      <option value="ace/mode/tsx">tsx</option>
                      <option value="ace/mode/twig">twig</option>
                      <option value="ace/mode/typescript">typescript</option>
                      <option value="ace/mode/vala">vala</option>
                      <option value="ace/mode/vbscript">vbscript</option>
                      <option value="ace/mode/velocity">velocity</option>
                      <option value="ace/mode/verilog">verilog</option>
                      <option value="ace/mode/vhdl">vhdl</option>
                      <option value="ace/mode/wollok">wollok</option>
                      <option value="ace/mode/xml">xml</option>
                      <option value="ace/mode/xquery">xquery</option>
                      <option value="ace/mode/yaml">yaml</option>
                  </select>
				  <label>文件格式</label>
			  </div>
			
			
            <a class="waves-effect waves-light btn" @click="cancel"><i class="material-icons left">keyboard_arrow_left</i>返回</a>
            <a class="waves-effect waves-light btn" @click="save"><i class="material-icons left">save</i>保存</a>


<!--
            <textarea v-model="content.data" spellcheck="false" style="width:100%; margin-top:10px; height:calc(100vh - 135px);
                caret-color:red;
                white-space: nowrap;"></textarea>
-->
<div id="editor-panel" style="width:100%; height:calc(100vh - 200px); "></div>


        </div>
        <!-- loading -->
        <div v-show="loading" style="position: fixed;top:0;left:0;width:100%;height:100vh;
            background:rgba(0,0,0,.8);
            z-index:10000;
            padding-top:200px;
            text-align:center;">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p style="color:white;">
                加载中...
            </p>
        </div>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdn.bootcss.com/materialize/0.97.8/js/materialize.min.js"></script>
    <script src="https://unpkg.com/ace-builds@1.4.8/src-min-noconflict/ace.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
    <script>
        const app = new Vue({
            el: '#app',
            data() {
                return {
                    loading: false,
                    // 版本
                    ver: '',
                    // 支持直接打开的文件
                    ext: ['yaml', 'log', 'conf', 'py', 'json', 'js', 'html', 'css'],
                    // 编辑内容
                    content: {
                        path: '',
                        data: ''
                    },
                    // 目录
                    dir: [],
                    // 列表
                    list: []
                }
            },
            filters: {
                format(value) {
                    if (value == 0) return ''
                    if (value >= 1024 * 1024) return `${(value / (1024 * 1024)).toFixed(2)} MB`
                    if (value >= 1024) return `${(value / 1024).toFixed(2)} KB`
                    return `${value} B`
                }
            },
            created() {
                let query = new URLSearchParams(location.search)
                this.ver = query.get('ver')
                this.getList('')
            },
            methods: {
                show({ type, url }) {
                    if (type === 'dir') {
                        this.dir.push(url)
                        let dir = this.dir.join('/')
                        this.getList(dir)
                    } else {
                        let index = url.lastIndexOf('.')
                        if (index > 0) {
                            let ext = url.substr(index + 1)
                            let isOpen = this.ext.includes(ext)
                            if (isOpen == false) {
                                isOpen = top.confirm("只能打开文本文件，确定编辑这个文件吗？")
                            }
                            if (isOpen) {
                                this.getContent(this.dir.join('/') + '/' + url)
                            }
                        }
                    }
                },				
				deleteClick({ type, url }){
				    
					if(top.confirm(`确定删除${type === 'dir' ? '文件夹' : '文件'}【${url}】`)){
					
						if(this.dir.length > 0) url = this.dir.join('/') + '/' + url
					
						if (type === 'dir') {
							console.log('删除目录',url)
						} else {
							console.log('删除文件',url)
						}	
						
						this.http({
						  type: 'delete',
						  path: url
						}).then(res=>{							
                            this.toast(res.msg)
							this.getList(this.dir.join('/'))
						})
						
					}
					
					
					
				},
                opendir(item) {
                    let index = this.dir.indexOf(item) + 1
                    if (index == this.dir.length) return;
                    this.dir.splice(index, this.dir.length - index)
                    this.getList(this.dir.join('/'))
                },
                async http(params) {
                    this.loading = true
                    try {
                        let hass = top.document.querySelector('home-assistant').hass
                        let { expired } = hass.auth
                        // 过期
                        if (expired) {
                            await hass.auth.refreshAccessToken()
                        }
                        return fetch(`${top.location.pathname}-api`, {
                            method: 'post',
                            headers: {
                                authorization: `${hass.auth.data.token_type} ${hass.auth.accessToken}`
                            },
                            body: JSON.stringify(params)
                        }).then(res => res.json()).finally(() => {
                            this.loading = false
                        })
                    } catch (ex) {
                        this.loading = false
                        return Promise.reject(ex)
                    }
                },
                toast(msg) {

                    Materialize.toast(msg, 3000)

                },
                getContent(path) {
                    this.http({
                        type: 'content',
                        path
                    }).then(res => {
                        if (res.code == 0) {
                            this.content.path = path							
							document.querySelector('#editor-panel').innerHTML = `<pre id="editor" style="width:100%;height:100%;" ></pre>`
							document.querySelector('#editor').textContent = res.data
							setTimeout(()=>{							
								// 获取后缀
								let index = path.lastIndexOf('.')
								let ext = path.substr(index+1)
								let mode = `ace/mode/${ext}`
								let option = document.querySelector(`#mode option[value='${mode}']`)
								if(!option){
									let obj = {
										'js': 'javascript',
										'py': 'python'
									}
									mode = `ace/mode/${obj[ext] || 'text'}`
								}		
								console.log(mode)
								window.editor = ace.edit("editor", {
									theme: "ace/theme/chrome",
									mode
								});
							}, 500)

                        } else {
                            this.toast(res.msg)
                        }
                    })
                },
                save() {
                    let { path } = this.content
                    if (path) {
						let data = window.editor.getValue()
                        this.http({
                            type: 'set',
                            path, data
                        }).then(res => {
                            this.toast(res.msg)

                        })
                    }
                },
                cancel() {
                    this.content.path = ''
                    this.content.data = ''
                },
                getList(path) {
                    this.http({
                        type: 'get',
                        path
                    }).then(res => {
						if(res.length>0){
							this.list = res
							
							setTimeout(()=>{
							
								$('.dropdown-button').dropdown();
							
							},500)
							
							  
							  
						}else{
							this.toast('这是一个空目录')
						}
                    })
                }
            }
        })
    </script>
	
    
    <script>
          $(document).ready(function() {
			$('select').material_select();
			   $(".button-collapse").sideNav();

		  });
     
        // 设置全屏模式
        try {
            let haPanelIframe = top.document.body
                .querySelector("home-assistant")
                .shadowRoot.querySelector("home-assistant-main")
                .shadowRoot.querySelector("app-drawer-layout partial-panel-resolver ha-panel-iframe").shadowRoot
            let ha_card = haPanelIframe.querySelector("iframe");
            ha_card.style.position = 'absolute'
			haPanelIframe.querySelector('app-toolbar').style.display = 'none'
			ha_card.style.top = '0'
			ha_card.style.height = '100%'

        } catch (ex) {

        }
    </script>
	<script>var _hmt=_hmt||[]window._hmt=_hmt;(function(){var hm=document.createElement('script')hm.src='https://hm.baidu.com/hm.js?52d57d8b7588a022f89c451d06e311f0'var s=document.getElementsByTagName('script')[0]s.parentNode.insertBefore(hm,s)})();</script>
</body>

</html>